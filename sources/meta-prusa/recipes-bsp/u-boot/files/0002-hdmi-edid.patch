From 19227755dcf0b7834a3a27c8d47d6c9e14f12e85 Mon Sep 17 00:00:00 2001
From: Roman Beranek <roman.beranek@prusa3d.com>
Date: Fri, 12 Apr 2019 17:29:49 +0200

---
 .gitignore                          |  1 +
 drivers/video/sunxi/sunxi_dw_hdmi.c | 26 ++++++++++++++++++++++++--
 2 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/.gitignore b/.gitignore
index 2e1c8bf2bf..4699c674ef 100644
--- a/.gitignore
+++ b/.gitignore
@@ -33,6 +33,7 @@
 
 # Build tree
 /build-*
+/out
 
 #
 # Top-level generic files
diff --git a/drivers/video/sunxi/sunxi_dw_hdmi.c b/drivers/video/sunxi/sunxi_dw_hdmi.c
index c87c919a52..2c40d0420f 100644
--- a/drivers/video/sunxi/sunxi_dw_hdmi.c
+++ b/drivers/video/sunxi/sunxi_dw_hdmi.c
@@ -298,8 +298,29 @@ static int sunxi_dw_hdmi_phy_cfg(struct dw_hdmi *hdmi, uint mpixelclock)
 static int sunxi_dw_hdmi_read_edid(struct udevice *dev, u8 *buf, int buf_size)
 {
 	struct sunxi_dw_hdmi_priv *priv = dev_get_priv(dev);
+	int i;
+
+	//force EDID in u-boot to initialize HDMI
+	u8 edid[] = {
+		0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x52, 0x62, 0x88, 0x88, 0x00, 0x88, 0x88, 0x88,
+		0x1c, 0x15, 0x01, 0x03, 0x81, 0x00, 0x00, 0x78, 0x0a, 0xda, 0xff, 0xa3, 0x58, 0x4a, 0xa2, 0x29,
+		0x17, 0x49, 0x4b, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
+		0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x3a, 0xa0, 0xa6, 0x50, 0x00, 0x08, 0xa0, 0x64, 0x0a,
+		0x31, 0x00, 0x44, 0x7a, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x57, 0x48, 0x59,
+		0x20, 0x54, 0x48, 0x49, 0x53, 0x20, 0x53, 0x48, 0x49, 0x54, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x57,
+		0x48, 0x59, 0x3f, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfd,
+		0x00, 0x17, 0x46, 0x0f, 0xa0, 0x1e, 0x00, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0x05
+	};
+	memcpy(buf, edid, sizeof(edid));
+
+	debug("\nforced EDID:\n");
+	for(i = 0; i < sizeof(edid); i++){
+		debug("0x%02x ", *(buf + i));
+		if(((i + 1) % 8) == 0) debug("\n");
+	}
 
-	return dw_hdmi_read_edid(&priv->hdmi, buf, buf_size);
+	return sizeof(edid);
+	//return dw_hdmi_read_edid(&priv->hdmi, buf, buf_size);
 }
 
 static int sunxi_dw_hdmi_enable(struct udevice *dev, int panel_bpp,
@@ -361,7 +382,8 @@ static int sunxi_dw_hdmi_probe(struct udevice *dev)
 
 	sunxi_dw_hdmi_phy_init();
 
-	ret = sunxi_dw_hdmi_wait_for_hpd();
+	//ret = sunxi_dw_hdmi_wait_for_hpd();
+	ret = 1; // expext hdmi always connected
 	if (ret < 0) {
 		debug("hdmi can not get hpd signal\n");
 		return -1;
