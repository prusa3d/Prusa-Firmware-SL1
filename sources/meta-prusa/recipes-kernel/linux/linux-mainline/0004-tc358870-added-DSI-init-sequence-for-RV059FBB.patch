From 425e6027aad970f52f109cd777637966ad2f43d8 Mon Sep 17 00:00:00 2001
From: Roman Beranek <roman.beranek@prusa3d.com>
Date: Tue, 8 Dec 2020 16:05:13 +0100
Subject: [PATCH] tc358870: added DSI init sequence for RV059FBB

---
 drivers/gpu/drm/bridge/tc358870/Makefile      |   4 +-
 .../gpu/drm/bridge/tc358870/tc358870_drv.c    |   3 +
 .../bridge/tc358870/tc358870_init_rv059fbb.c  | 264 ++++++++++++++++++
 .../gpu/drm/bridge/tc358870/tc358870_msg.h    |   1 +
 4 files changed, 271 insertions(+), 1 deletion(-)
 create mode 100644 drivers/gpu/drm/bridge/tc358870/tc358870_init_rv059fbb.c

diff --git a/drivers/gpu/drm/bridge/tc358870/Makefile b/drivers/gpu/drm/bridge/tc358870/Makefile
index be0fce06a82f..345566085b03 100644
--- a/drivers/gpu/drm/bridge/tc358870/Makefile
+++ b/drivers/gpu/drm/bridge/tc358870/Makefile
@@ -1,4 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
-tc358870-objs := tc358870_drv.o tc358870_init_ls055r1sx04.o
+tc358870-objs := tc358870_drv.o
+tc358870-objs += tc358870_init_ls055r1sx04.o
+tc358870-objs += tc358870_init_rv059fbb.o
 CFLAGS_tc358870_init_ls055r1sx04.o += -Wno-missing-braces
 obj-$(CONFIG_DRM_TOSHIBA_TC358870) += tc358870.o
diff --git a/drivers/gpu/drm/bridge/tc358870/tc358870_drv.c b/drivers/gpu/drm/bridge/tc358870/tc358870_drv.c
index 7b234a25befe..de2c6faace51 100644
--- a/drivers/gpu/drm/bridge/tc358870/tc358870_drv.c
+++ b/drivers/gpu/drm/bridge/tc358870/tc358870_drv.c
@@ -183,6 +183,7 @@ static int tc358870_init(struct tc358870 *priv)
 enum panel_type {
 	PANEL_TYPE_UNKNOWN,
 	PANEL_TYPE_LS055R1SX04,
+	PANEL_TYPE_RV059FBB,
 };
 
 static enum panel_type tc358870_get_panel_type(struct device *dev)
@@ -191,6 +192,7 @@ static enum panel_type tc358870_get_panel_type(struct device *dev)
 	static const char *const names[] = {
 		[PANEL_TYPE_UNKNOWN]		= "",
 		[PANEL_TYPE_LS055R1SX04]	= "ls055r1sx04",
+		[PANEL_TYPE_RV059FBB]		= "rv059fbb",
 	};
 	const char *panel_name;
 	ret = of_property_read_string(dev->of_node, "panel-name", &panel_name);
@@ -219,6 +221,7 @@ static const struct tc358870_msg *tc358870_get_dsi_init_data(struct device *dev)
 	static const struct tc358870_msg *const init_data[] = {
 		[PANEL_TYPE_UNKNOWN]		= NULL,
 		[PANEL_TYPE_LS055R1SX04]	= ls055r1sx04_dsi_init_data,
+		[PANEL_TYPE_RV059FBB]		= rv059fbb_dsi_init_data,
 	};
 	enum panel_type type = tc358870_get_panel_type(dev);
 	if (type < 0 || type >= ARRAY_SIZE(init_data))
diff --git a/drivers/gpu/drm/bridge/tc358870/tc358870_init_rv059fbb.c b/drivers/gpu/drm/bridge/tc358870/tc358870_init_rv059fbb.c
new file mode 100644
index 000000000000..5501e80b6f81
--- /dev/null
+++ b/drivers/gpu/drm/bridge/tc358870/tc358870_init_rv059fbb.c
@@ -0,0 +1,264 @@
+// SPDX-License-Identifier: GPL-2.0
+/*
+ * Copyright (C) 2020, Prusa Development, a.s.
+ * Written by Roman Beranek <roman.beranek@prusa3d.com>
+ */
+
+#include "tc358870_msg.h"
+
+#define HX8252_WRITE_SEQ(reg, val) \
+	{{0x05, 0x04, 0x39, 0x80}, 4}, \
+	{{0x05, 0x04, 0x02, 0x00}, 4}, \
+	{{0x05, 0x04,  reg,  val}, 4}, \
+	{{0x05, 0x04, 0x03, 0x00}, 4}, \
+	{{0x05, 0x04, 0x00, 0x00}, 4}
+
+const struct tc358870_msg rv059fbb_dsi_init_data[] = {
+	{{0x00, 0x04, 0x04, 0x00}, 4},
+	{{0x00, 0x02, 0x00, 0x12}, 4},
+	USLEEP(1000),
+	{{0x00, 0x02, 0x00, 0x00}, 4},
+	{{0x00, 0x06, 0x08, 0x00}, 4},
+	{{0x01, 0x08, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x0C, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0xA0, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0xAC, 0x6D, 0x90, 0x00, 0x00}, 6},
+	USLEEP(2000),
+	{{0x02, 0xA0, 0x03, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x18, 0x14, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x20, 0x34, 0x0E, 0x00, 0x00}, 6},
+	{{0x01, 0x24, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x28, 0x01, 0x01, 0x00, 0x00}, 6},
+	{{0x01, 0x30, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x01, 0x34, 0x00, 0x50, 0x00, 0x00}, 6},
+	{{0x01, 0x38, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x01, 0x3C, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x01, 0x40, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x01, 0x44, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x01, 0x48, 0x00, 0x10, 0x00, 0x00}, 6},
+	{{0x01, 0x4C, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x01, 0x50, 0x60, 0x01, 0x00, 0x00}, 6},
+	{{0x01, 0x54, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x58, 0xC8, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x68, 0x2A, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x70, 0xE8, 0x01, 0x00, 0x00}, 6},
+	{{0x01, 0x7C, 0x81, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x8C, 0x21, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x90, 0x91, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0xA4, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0xC0, 0x15, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x14, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x1C, 0x80, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x24, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x54, 0x03, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x58, 0x03, 0x02, 0x18, 0x00}, 6},
+	{{0x02, 0x5C, 0x07, 0x00, 0x08, 0x00}, 6},
+	{{0x02, 0x60, 0x05, 0x00, 0x0C, 0x00}, 6},
+	{{0x02, 0x64, 0x09, 0x47, 0x00, 0x00}, 6},
+	{{0x02, 0x68, 0x0B, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x6C, 0x06, 0x00, 0x08, 0x00}, 6},
+	{{0x02, 0x70, 0x20, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x74, 0x1F, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x78, 0x03, 0x00, 0x03, 0x00}, 6},
+	{{0x02, 0x7C, 0x02, 0x00, 0x00, 0x00}, 6},
+	{{0x02, 0x88, 0xAA, 0x02, 0x00, 0x00}, 6},
+	{{0x01, 0x1C, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x08, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x0C, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0xA0, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0xAC, 0x6D, 0x90, 0x00, 0x00}, 6},
+	USLEEP(2000),
+	{{0x04, 0xA0, 0x03, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x18, 0x14, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x20, 0x34, 0x0E, 0x00, 0x00}, 6},
+	{{0x03, 0x24, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x28, 0x01, 0x01, 0x00, 0x00}, 6},
+	{{0x03, 0x30, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x03, 0x34, 0x00, 0x50, 0x00, 0x00}, 6},
+	{{0x03, 0x38, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x03, 0x3C, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x03, 0x40, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x03, 0x44, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x03, 0x48, 0x00, 0x10, 0x00, 0x00}, 6},
+	{{0x03, 0x4C, 0x00, 0x00, 0x01, 0x00}, 6},
+	{{0x03, 0x50, 0x60, 0x01, 0x00, 0x00}, 6},
+	{{0x03, 0x54, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x58, 0xC8, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x68, 0x2A, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x70, 0xE8, 0x01, 0x00, 0x00}, 6},
+	{{0x03, 0x7C, 0x81, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x8C, 0x21, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x90, 0x91, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0xA4, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0xC0, 0x15, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x14, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x1C, 0x80, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x24, 0x00, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x54, 0x03, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x58, 0x03, 0x02, 0x18, 0x00}, 6},
+	{{0x04, 0x5C, 0x07, 0x00, 0x08, 0x00}, 6},
+	{{0x04, 0x60, 0x05, 0x00, 0x0C, 0x00}, 6},
+	{{0x04, 0x64, 0x09, 0x47, 0x00, 0x00}, 6},
+	{{0x04, 0x68, 0x0B, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x6C, 0x06, 0x00, 0x08, 0x00}, 6},
+	{{0x04, 0x70, 0x20, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x74, 0x1F, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x78, 0x03, 0x00, 0x03, 0x00}, 6},
+	{{0x04, 0x7C, 0x02, 0x00, 0x00, 0x00}, 6},
+	{{0x04, 0x88, 0xAA, 0x02, 0x00, 0x00}, 6},
+	{{0x03, 0x1C, 0x01, 0x00, 0x00, 0x00}, 6},
+	{{0x01, 0x10, 0x16, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x10, 0x16, 0x00, 0x00, 0x00}, 6},
+	USLEEP(1250),
+	{{0x05, 0x00, 0x04, 0x00}, 4},
+	HX8252_WRITE_SEQ(0xB0, 0x00),
+	HX8252_WRITE_SEQ(0xB2, 0x02),
+	HX8252_WRITE_SEQ(0xB3, 0x05),
+	HX8252_WRITE_SEQ(0xB4, 0x40),
+	HX8252_WRITE_SEQ(0xB6, 0x80),
+	HX8252_WRITE_SEQ(0xB9, 0x08),
+	HX8252_WRITE_SEQ(0xBA, 0x43),
+	HX8252_WRITE_SEQ(0xBB, 0x5A),
+	HX8252_WRITE_SEQ(0xBE, 0x32),
+	HX8252_WRITE_SEQ(0xBF, 0x1E),
+	HX8252_WRITE_SEQ(0xCB, 0x2F),
+	HX8252_WRITE_SEQ(0xCD, 0x2F),
+	HX8252_WRITE_SEQ(0xCF, 0x03),
+	HX8252_WRITE_SEQ(0xD1, 0x00),
+	HX8252_WRITE_SEQ(0xB0, 0x01),
+	HX8252_WRITE_SEQ(0xC0, 0x00),
+	HX8252_WRITE_SEQ(0xC1, 0x08),
+	HX8252_WRITE_SEQ(0xC2, 0x08),
+	HX8252_WRITE_SEQ(0xC3, 0x06),
+	HX8252_WRITE_SEQ(0xC4, 0x06),
+	HX8252_WRITE_SEQ(0xC5, 0x0C),
+	HX8252_WRITE_SEQ(0xC6, 0x0C),
+	HX8252_WRITE_SEQ(0xC7, 0x0A),
+	HX8252_WRITE_SEQ(0xC8, 0x0A),
+	HX8252_WRITE_SEQ(0xC9, 0x00),
+	HX8252_WRITE_SEQ(0xCA, 0x00),
+	HX8252_WRITE_SEQ(0xCB, 0x25),
+	HX8252_WRITE_SEQ(0xCC, 0x00),
+	HX8252_WRITE_SEQ(0xCD, 0x02),
+	HX8252_WRITE_SEQ(0xCE, 0x04),
+	HX8252_WRITE_SEQ(0xCF, 0x0D),
+	HX8252_WRITE_SEQ(0xD0, 0x0F),
+	HX8252_WRITE_SEQ(0xD1, 0x0E),
+	HX8252_WRITE_SEQ(0xD2, 0x00),
+	HX8252_WRITE_SEQ(0xD3, 0x00),
+	HX8252_WRITE_SEQ(0xD4, 0x00),
+	HX8252_WRITE_SEQ(0xD5, 0x00),
+	HX8252_WRITE_SEQ(0xD6, 0x00),
+	HX8252_WRITE_SEQ(0xD7, 0x07),
+	HX8252_WRITE_SEQ(0xD8, 0x07),
+	HX8252_WRITE_SEQ(0xD9, 0x05),
+	HX8252_WRITE_SEQ(0xDA, 0x05),
+	HX8252_WRITE_SEQ(0xDB, 0x0B),
+	HX8252_WRITE_SEQ(0xDC, 0x0B),
+	HX8252_WRITE_SEQ(0xDD, 0x09),
+	HX8252_WRITE_SEQ(0xDE, 0x09),
+	HX8252_WRITE_SEQ(0xDF, 0x00),
+	HX8252_WRITE_SEQ(0xE0, 0x00),
+	HX8252_WRITE_SEQ(0xE1, 0x25),
+	HX8252_WRITE_SEQ(0xE2, 0x00),
+	HX8252_WRITE_SEQ(0xE3, 0x01),
+	HX8252_WRITE_SEQ(0xE4, 0x03),
+	HX8252_WRITE_SEQ(0xE5, 0x0D),
+	HX8252_WRITE_SEQ(0xE6, 0x0F),
+	HX8252_WRITE_SEQ(0xE7, 0x0E),
+	HX8252_WRITE_SEQ(0xE8, 0x00),
+	HX8252_WRITE_SEQ(0xE9, 0x00),
+	HX8252_WRITE_SEQ(0xEA, 0x00),
+	HX8252_WRITE_SEQ(0xEB, 0x00),
+	HX8252_WRITE_SEQ(0xEC, 0xC0),
+	HX8252_WRITE_SEQ(0xB0, 0x02),
+	HX8252_WRITE_SEQ(0xC0, 0x00),
+	HX8252_WRITE_SEQ(0xC1, 0x04),
+	HX8252_WRITE_SEQ(0xC2, 0x13),
+	HX8252_WRITE_SEQ(0xC3, 0x1A),
+	HX8252_WRITE_SEQ(0xC4, 0x25),
+	HX8252_WRITE_SEQ(0xC5, 0x17),
+	HX8252_WRITE_SEQ(0xC6, 0x17),
+	HX8252_WRITE_SEQ(0xC7, 0x17),
+	HX8252_WRITE_SEQ(0xC8, 0x14),
+	HX8252_WRITE_SEQ(0xC9, 0x0C),
+	HX8252_WRITE_SEQ(0xCA, 0x09),
+	HX8252_WRITE_SEQ(0xCB, 0x02),
+	HX8252_WRITE_SEQ(0xCC, 0x06),
+	HX8252_WRITE_SEQ(0xCD, 0x00),
+	HX8252_WRITE_SEQ(0xCE, 0x06),
+	HX8252_WRITE_SEQ(0xCF, 0x00),
+	HX8252_WRITE_SEQ(0xD0, 0x07),
+	HX8252_WRITE_SEQ(0xD1, 0x1F),
+	HX8252_WRITE_SEQ(0xD2, 0x23),
+	HX8252_WRITE_SEQ(0xD3, 0x28),
+	HX8252_WRITE_SEQ(0xD4, 0x15),
+	HX8252_WRITE_SEQ(0xD5, 0x1F),
+	HX8252_WRITE_SEQ(0xD6, 0x00),
+	HX8252_WRITE_SEQ(0xD7, 0x04),
+	HX8252_WRITE_SEQ(0xD8, 0x13),
+	HX8252_WRITE_SEQ(0xD9, 0x1A),
+	HX8252_WRITE_SEQ(0xDA, 0x25),
+	HX8252_WRITE_SEQ(0xDB, 0x17),
+	HX8252_WRITE_SEQ(0xDC, 0x17),
+	HX8252_WRITE_SEQ(0xDD, 0x17),
+	HX8252_WRITE_SEQ(0xDE, 0x14),
+	HX8252_WRITE_SEQ(0xDF, 0x0C),
+	HX8252_WRITE_SEQ(0xE0, 0x09),
+	HX8252_WRITE_SEQ(0xE1, 0x02),
+	HX8252_WRITE_SEQ(0xE2, 0x06),
+	HX8252_WRITE_SEQ(0xE3, 0x00),
+	HX8252_WRITE_SEQ(0xE4, 0x06),
+	HX8252_WRITE_SEQ(0xE5, 0x00),
+	HX8252_WRITE_SEQ(0xE6, 0x07),
+	HX8252_WRITE_SEQ(0xE7, 0x1F),
+	HX8252_WRITE_SEQ(0xE8, 0x23),
+	HX8252_WRITE_SEQ(0xE9, 0x28),
+	HX8252_WRITE_SEQ(0xEA, 0x15),
+	HX8252_WRITE_SEQ(0xEB, 0x1F),
+	HX8252_WRITE_SEQ(0xB0, 0x03),
+	HX8252_WRITE_SEQ(0xC0, 0x01),
+	HX8252_WRITE_SEQ(0xC8, 0x0B),
+	HX8252_WRITE_SEQ(0xC9, 0x07),
+	HX8252_WRITE_SEQ(0xCC, 0x33),
+	HX8252_WRITE_SEQ(0xC2, 0xFF),
+	HX8252_WRITE_SEQ(0xC3, 0x00),
+	HX8252_WRITE_SEQ(0xC4, 0xFF),
+	HX8252_WRITE_SEQ(0xC5, 0x00),
+	HX8252_WRITE_SEQ(0xDD, 0xFF),
+	HX8252_WRITE_SEQ(0xDE, 0x00),
+	HX8252_WRITE_SEQ(0xE6, 0xFF),
+	HX8252_WRITE_SEQ(0xE7, 0x00),
+	HX8252_WRITE_SEQ(0xCA, 0x41),
+	HX8252_WRITE_SEQ(0xE4, 0x00),
+	HX8252_WRITE_SEQ(0xE5, 0x0F),
+	HX8252_WRITE_SEQ(0xD4, 0x04),
+	HX8252_WRITE_SEQ(0xDB, 0x00),
+	HX8252_WRITE_SEQ(0xD2, 0x00),
+	HX8252_WRITE_SEQ(0xD6, 0x8A),
+	HX8252_WRITE_SEQ(0xD5, 0x0A),
+	HX8252_WRITE_SEQ(0xD3, 0x07),
+	HX8252_WRITE_SEQ(0xCF, 0x00),
+	HX8252_WRITE_SEQ(0xCB, 0x00),
+	HX8252_WRITE_SEQ(0x36, 0x48), /* RGB, X-flipped -> BGR, normal */
+	{{0x05, 0x04, 0x05, 0x00}, 4},
+	{{0x05, 0x04, 0x29, 0x00}, 4},
+	{{0x05, 0x04, 0x05, 0x00}, 4},
+	{{0x05, 0x04, 0x11, 0x00}, 4},
+	USLEEP(330000),
+	{{0x50, 0x00, 0x00, 0x00}, 4},
+	{{0x50, 0x08, 0x54, 0x06}, 4},
+	{{0x50, 0x0C, 0x00, 0x00}, 4},
+	{{0x50, 0x0E, 0x1B, 0x02}, 4},
+	{{0x50, 0x80, 0x00, 0x00}, 4},
+	{{0x50, 0x88, 0x54, 0x06}, 4},
+	{{0x50, 0x8C, 0x00, 0x00}, 4},
+	{{0x50, 0x8E, 0x1B, 0x02}, 4},
+	{{0x50, 0x0A, 0x00, 0x00}, 4},
+	{{0x50, 0x8A, 0x00, 0x00}, 4},
+	{{0x00, 0x04, 0x37, 0x0C}, 4},
+	{{0x00, 0x06, 0x00, 0x00}, 4},
+	{{0x01, 0x10, 0x06, 0x00, 0x00, 0x00}, 6},
+	{{0x03, 0x10, 0x06, 0x00, 0x00, 0x00}, 6},
+	INIT_END,
+};
diff --git a/drivers/gpu/drm/bridge/tc358870/tc358870_msg.h b/drivers/gpu/drm/bridge/tc358870/tc358870_msg.h
index 30d614603d31..18bf0b9de80f 100644
--- a/drivers/gpu/drm/bridge/tc358870/tc358870_msg.h
+++ b/drivers/gpu/drm/bridge/tc358870/tc358870_msg.h
@@ -21,3 +21,4 @@ struct tc358870_msg
 };
 
 extern const struct tc358870_msg ls055r1sx04_dsi_init_data[];
+extern const struct tc358870_msg rv059fbb_dsi_init_data[];
-- 
2.34.1

